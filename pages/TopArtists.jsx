import react, { useEffect } from "react";
import Head from "next/head";
import styles from "../styles/pages/Tops.module.scss";
import RankingItemArtist from "../src/components/RankingItemArtist";
import { login, SpotifyApi, runRefreshToken } from "../src/services/spotify";
import nookies from "nookies";

export default function TopArtists({ data, runLogin }) {
  const { topS, topM, topL } = data;
  useEffect(() => {
    if (runLogin) {
      console.error("no token");
      login();
    }
  }, [runLogin]);

  function mountList(track, index) {
    if (index === 0) {
      return (
        <RankingItemArtist
          rank={index + 1}
          img={track.images[1].url}
          title={track.name}
          bgc="#fcdb66"
          fc="black"
          key={index}
        />
      );
    } else if (index === 1) {
      return (
        <RankingItemArtist
          rank={index + 1}
          img={track.images[1].url}
          title={track.name}
          bgc="#afb8c0"
          fc="black"
          key={index}
        />
      );
    } else if (index === 2) {
      return (
        <RankingItemArtist
          rank={index + 1}
          img={track.images[1].url}
          title={track.name}
          bgc="#c59455"
          fc="black"
          key={index}
        />
      );
    } else {
      return (
        <RankingItemArtist
          rank={index + 1}
          img={track.images[1].url}
          title={track.name}
          bgc="#212121"
          fc="white"
          key={index}
        />
      );
    }
  }

  return (
    <div className={styles.container}>
      <Head>
        <title>Spotify Stats - Top Artists</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <div className={styles.pageTitle}>
        <h2>Top Artists</h2>
      </div>

      <div className={styles.top}>
        <div className={styles.timePeriod}>
          <h3>1 month</h3>
          <div>
            <ul>{topS.map((track, index) => mountList(track, index))}</ul>
          </div>
        </div>
        <div className={styles.timePeriod}>
          <h3>6 months</h3>
          <div>
            <ul>{topM.map((track, index) => mountList(track, index))}</ul>
          </div>
        </div>
        <div className={styles.timePeriod}>
          <h3>6 months</h3>
          <div>
            <ul>{topL.map((track, index) => mountList(track, index))}</ul>
          </div>
        </div>
      </div>
    </div>
  );
}

export async function getServerSideProps(ctx) {
  const cookies = nookies.get(ctx);

  if (cookies.access_token) {
    const data = await getLists(cookies.access_token);

    if (data.err) {
      return {
        props: { data: { topS: [], topM: [], topL: [] }, runLogin: true },
      };
    }

    return { props: { data, runLogin: false } };
  } else {
    return {
      props: { data: { topS: [], topM: [], topL: [] }, runLogin: true },
    };
  }
}

async function getLists(token) {
  SpotifyApi.setAccessToken(token);
  try {
    const topS = await SpotifyApi.getMyTopArtists({
      limit: 10,
      offset: 0,
      time_range: "short_term",
    });

    const topM = await SpotifyApi.getMyTopArtists({
      limit: 10,
      offset: 0,
      time_range: "medium_term",
    });

    const topL = await SpotifyApi.getMyTopArtists({
      limit: 10,
      offset: 0,
      time_range: "long_term",
    });

    return {
      topS: topS.body.items,
      topM: topM.body.items,
      topL: topL.body.items,
    };
  } catch (e) {
    if (e.body.message === "The access token expired") {
      const newCookies = await runRefreshToken(ctx);
      SpotifyApi.setAccessToken(newCookies.access_token);
      try {
        const topS = await SpotifyApi.getMyTopArtists({
          limit: 10,
          offset: 0,
          time_range: "short_term",
        });

        const topM = await SpotifyApi.getMyTopArtists({
          limit: 10,
          offset: 0,
          time_range: "medium_term",
        });

        const topL = await SpotifyApi.getMyTopArtists({
          limit: 10,
          offset: 0,
          time_range: "long_term",
        });

        return {
          topS: topS.body.items,
          topM: topM.body.items,
          topL: topL.body.items,
        };
      } catch (err) {
        console.error("second err", err);
      }
    }
  }
}
